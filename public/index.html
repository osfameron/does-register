<html ng-app>
<head>
    <link rel="stylesheet" type="text/css" href="/stylesheets/style.css" media="screen" />
    <script src="http://code.jquery.com/jquery-1.10.2.js"></script>
    <link rel="stylesheet" href="//code.jquery.com/ui/1.10.4/themes/smoothness/jquery-ui.css">
    <script src="http://code.jquery.com/ui/1.10.4/jquery-ui.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.0-beta.5/angular.min.js"></script>

    <script> 
        <!-- Angular controllers -->

        function VisitCtrl($scope) {
            $scope.visits = [];

            $scope.end_visit = function (visit) {
                console.log(visit, visit.visit_id);
                $scope.socket.emit('end_visit', visit.visit_id);
            }
        }

        $(function () {

            <!-- PocketIO -->
            var socket = io.connect( );
            var $visit = $('table#visits').scope();
            $visit.$apply( function () { $visit.socket = socket });

            socket.on('connect', function () {
                console.log('CONNECTED');
            });
         
            socket.on('visits', function (visits) {
                $visit.$apply( function () { $visit.visits = visits });
            });

            socket.emit('hello'); // Tell server we are ready for first visits list

            <!-- JQuery -->

            function member_search_create (socket, position, callback) {
                socket.emit('get_members', function (members) {
                    $.each(members, function (i,m) {
                        m.label = m.name;
                    });
                    div = $('<div class="member_widget">');
                    input = $('<input type="text" name="member_name">');
                    create = $('<button name="create_new"> Create </button>')
                        .click(function () { alert("TODO") });
                    cancel = $('<button name="create_new"> Cancel </button>')
                        .click(function () { div.remove() });
                    div.append(input, create, cancel);
                    input.autocomplete({ 
                        source: members,
                        select: function (event, ui) {
                            callback(socket, ui.item);
                            div.remove();
                        }
                    });
                    div.insertAfter(position);
                    input.focus();
                });
            };

            $('#add_member .plus').unbind('click').click( function () {
                if ( $('#add_member input').length ) {
                    $('#add_member input').focus();
                    return;
                }
                member_search_create(socket, $(this), function (socket, item) {
                    socket.emit('member_visit', item.id);
                });
            });

        });
    </script>

</head>
<body>

  <div class="content">

    <table id="visits" ng-controller="VisitCtrl">
        <thead>
            <tr>
                <th colspan=3> User </th>
                <th colspan=2> PAYG </th>
                <th colspan=2> Time </th>
                <th> &nbsp; </th>
            </tr>
            <tr>
                <th> &nbsp; </th> <!-- gravatar -->
                <th> Name </th>
                <th> &nbsp; </th> <!-- type -->
                <th> left </th> <!-- number, and + to add more -->
                <th> used </th> <!-- select -->
                <th> in </th> <!-- hh:mm -->
                <th> out </th> <!-- hh:mm or none -->
                <th> &nbsp; </th>
            </tr>
        </thead>
        <tbody>
            <tr ng-repeat="visit in visits" class="{{ visit.active ? 'active' : 'inactive' }}">
                <td> <img src="{{ visit.icon }}" alt="Icon for {{ visit.name }}">
                <td class="visitor_name"> 
                    {{ visit.name }} 
                </td>
                <td class="membership_types">
                    <ul>
                        <li ng-repeat="type in visit.types">{{ type }}</li>
                    </ul>
                </td>
                <td class="num {{ visit.left < 0 ? 'overdue' : '' }}"> {{ visit.left }} </td>
                <td class="num {{ visit.flagged_hours ? 'overdue' : '' }}"> {{ visit.days_used }} </td>
                <td class="time"> {{ visit.in }} </td>
                <td ng-if="visit.out" class="time"> 
                    {{ visit.out }}  
                    <br />({{ visit.used_today }})
                </td>
                <td ng-if="! visit.out" class="time">
                    <img ng-click="end_visit(visit)" src="/images/icon_out.png" alt="out" />
                </td>
                <td> &nbsp; </td>
            </tr>
        </tbody>
    </table>
    <div id="add_member">
        <span class="plus"> + </span>
    </div>
  </div>
</body>  
</html>
